import idaapi
import idautils
import idc

def analyze_function(function_name):
    # 查找二进制文件中的函数地址
    func_ea = idc.get_name_ea(idc.BADADDR, function_name)
    
    if func_ea == idc.BADADDR:
        print(f"函数 '{function_name}' 未找到")
        return
    
    # 分析函数的控制流
    f = idaapi.get_func(func_ea)
    if not f:
        print(f"无法获取函数 '{function_name}'")
        return
    
    print(f"分析函数 '{function_name}'，入口地址: 0x{func_ea:08X}")
    
    for block in idaapi.FlowChart(f):
        print(f"基本块: 0x{block.start_ea:08X}")
        
        # 使用idautils.XrefsTo来获取交叉引用
        for head in idautils.Heads(block.start_ea, block.end_ea):
            disasm = idc.GetDisasm(head)
            print(f"    0x{head:08X}: {disasm}")
            
            # 识别交叉引用
            for ref in idautils.XrefsTo(head):
                print(f"        引用自: 0x{ref.frm}")
    
if __name__ == '__main__':
    target_function = "sub_4011E0"
    
    analyze_function(target_function)
